

services:
  # ğŸ¤– Telegram Bot Service
  telegram-bot: 
    build:
      context: .
      dockerfile: bot/Dockerfile
    container_name: telegram-bot
    restart: unless-stopped
    
    # ğŸ”§ ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ· .env Ñ„Ğ°Ğ¹Ğ»Ğ°
    env_file:
      - .env
    
    # ğŸ“ ĞœĞ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
    volumes:
      - ./logs:/app/logs
    
    # ğŸŒ Ğ¡ĞµÑ‚ÑŒ
    networks:
      - bot-network
    
    # ğŸ¥ Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # ğŸ“Š ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ğŸŒ Nginx Static Server
  nginx:
    image: nginx:alpine
    container_name: nginx-static
    restart: unless-stopped
    
    # ğŸ”Œ ĞŸĞ¾Ñ€Ñ‚Ñ‹
    ports:
      - "3010:3010" # Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ³Ğ¾ nginx
    
    # ğŸ“ ĞœĞ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
    volumes:
      # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Nginx
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      
      # Mini App ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
      - mini-app-dist:/usr/share/nginx/html/app:ro
      
      # Ğ›Ğ¾Ğ³Ğ¸
      - ./nginx/logs:/var/log/nginx
    
    # ğŸŒ Ğ¡ĞµÑ‚ÑŒ
    networks:
      - bot-network
    
    # ğŸ”— Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    depends_on:
      mini-app-builder:
        condition: service_completed_successfully
      telegram-bot:
        condition: service_healthy
    
    # ğŸ¥ Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ğŸ“Š Monitoring (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    
    # ğŸ“ ĞœĞ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Docker socket
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
    # âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=3600  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
      - WATCHTOWER_INCLUDE_RESTARTING=true
    
    # ğŸŒ Ğ¡ĞµÑ‚ÑŒ
    networks:
      - bot-network

  # ğŸ—ï¸ React Build Service
  mini-app-builder:
    image: node:18-alpine
    container_name: mini-app-builder
    working_dir: /app
    volumes:
      - ./mini-app:/app
      - mini-app-dist:/app/dist  # Named volume Ğ´Ğ»Ñ dist
    command: sh -c "npm install && npm run build"
    networks:
      - bot-network

# ğŸŒ Ğ¡ĞµÑ‚Ğ¸
networks:
  bot-network:
    driver: bridge
    name: telegram-bot-network

# ğŸ’¾ Volumes
volumes:
  # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Nginx (ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±ÑÑ‚ÑÑ Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼)
  nginx_data:
    driver: local
    name: nginx_data
  mini-app-dist:  # Named volume Ğ´Ğ»Ñ dist
