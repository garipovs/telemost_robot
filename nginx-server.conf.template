# üåê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–†–í–ï–†–ù–û–ì–û NGINX –î–õ–Ø TELEMOST BOT
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π nginx —Å–µ—Ä–≤–µ—Ä–∞

# üîó Upstream –¥–ª—è Telemost Bot (Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3010)
upstream telemost_bot {
    server 127.0.0.1:3010;
    keepalive 32;
}

# üè† –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä tlemst.ru
server {
    listen 80;
    listen 443 ssl http2;
    server_name tlemst.ru www.tlemst.ru;

    # üîí SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Let's Encrypt)
    # ssl_certificate /etc/letsencrypt/live/tlemst.ru/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/tlemst.ru/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    # ssl_prefer_server_ciphers off;

    # üì± Telemost Bot - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ /bot/telemost/*
    location /bot/telemost/ {
        # –£–±–∏—Ä–∞–µ–º /bot/telemost –∏–∑ –ø—É—Ç–∏ –ø–µ—Ä–µ–¥ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        rewrite ^/bot/telemost/(.*)$ /$1 break;
        
        # –ü—Ä–æ–∫—Å–∏—Ä—É–µ–º –∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
        proxy_pass http://telemost_bot;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        
        # WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # üè• Health check –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    location /bot/telemost/health {
        proxy_pass http://telemost_bot/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }

    # üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ä—Ç—É 3010
    location /3010/ {
        return 404;
    }

    # üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # üè† –ö–æ—Ä–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
    location = / {
        # –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        return 200 "Welcome to tlemst.ru\n";
        add_header Content-Type text/plain;
    }
}

# üîÑ –†–µ–¥–∏—Ä–µ–∫—Ç —Å www –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
server {
    listen 80;
    listen 443 ssl http2;
    server_name www.tlemst.ru;
    return 301 $scheme://tlemst.ru$request_uri;
}
